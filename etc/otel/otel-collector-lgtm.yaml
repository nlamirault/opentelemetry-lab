# SPDX-FileCopyrightText: Copyright (C) Nicolas Lamirault <nicolas.lamirault@gmail.com>
# SPDX-License-Identifier: Apache-2.0

---
receivers:
  tcplog/docker:
    listen_address: "0.0.0.0:2255"
    operators:
      - type: regex_parser
        regex: '^<([0-9]+)>[0-9]+ (?P<timestamp>[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]+)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?) (?P<container_id>\S+) (?P<container_name>\S+) [0-9]+ - -( (?P<body>.*))?'
        timestamp:
          parse_from: attributes.timestamp
          layout: '%Y-%m-%dT%H:%M:%S.%LZ'
      - type: move
        from: attributes["body"]
        to: body
      - type: remove
        field: attributes.timestamp
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
        cors:
          allowed_origins:
            - http://*
  prometheus/collector:
    config:
      global:
        scrape_interval: 60s
      scrape_configs:
      - job_name: 'otel-collector'
        scrape_interval: 30s
        static_configs:
        - targets:
            - 127.0.0.1:8888
          labels:
            job_name: otel-collector

extensions:
  health_check:
    endpoint: 0.0.0.0:13133
    path: "/ready"
  pprof:
    endpoint: 0.0.0.0:1777

processors:
  batch:
    send_batch_size: 10000
    send_batch_max_size: 11000
    timeout: 10s
  memory_limiter:
    check_interval: 2s
    limit_mib: 1800
    spike_limit_mib: 500
  attributes:
    actions:
    - key: instance
      action: insert
      value: opentelemetry-lab
  resourcedetection:
    detectors: [env, system]
    timeout: 2s

exporters:
  otlphttp/logs:
    endpoint: ${OTEL_EXPORTER_OTLP_LOGS_ENDPOINT}
    tls:
      insecure: true
  otlphttp/metrics:
    endpoint: ${OTEL_EXPORTER_OTLP_METRICS_ENDPOINT}
    tls:
      insecure: true
  # otlp/profiles:
  #   endpoint: ${OTEL_EXPORTER_OTLP_PROFILES_ENDPOINT}
  #   tls:
  #     insecure: true
  otlphttp/traces:
    endpoint: ${OTEL_EXPORTER_OTLP_TRACES_ENDPOINT}
    tls:
      insecure: true

  prometheus:
    endpoint: "0.0.0.0:8889"

  debug/metrics:
    verbosity: detailed
  debug/traces:
    verbosity: detailed
  debug/logs:
    verbosity: detailed

connectors:
  spanmetrics:
    dimensions:
    - name: http.method
    - name: http.status_code
    - name: http.route

service:
  telemetry:
    logs:
      encoding: json
    # metrics:
    #   address: 0.0.0.0:8888
  extensions:
    - health_check
    - pprof
  pipelines:
    logs:
      receivers:
      - otlp
      - tcplog/docker
      processors:
      - batch
      - attributes
      exporters:
      - otlphttp/logs
      - debug/logs
    metrics:
      receivers:
      - otlp
      - prometheus/collector
      processors:
      - resourcedetection
      - batch
      exporters:
      - otlphttp/metrics
      - debug/metrics
    # profiles:
    #   receivers:
    #   - otlp
    #   exporters:
    #   - otlp/profiles
    traces:
      receivers:
      - otlp
      processors:
      - batch
      exporters:
      - otlphttp/traces
      - debug/traces
    # metrics/spanmetrics:
    #   receivers: [spanmetrics]
    #   exporters: [prometheus]
